根据《中国电信业务规则IT支撑技术规范V2.0》的要求以及业务专家整理的 MVP 建模（灵犀专线案例），**LOGOS（智能规则中台）** 的变更已从“实验性原型”进化为“标准合规生产系统”。

以下是面向开发的详细变更说明与执行指南：

---

## 一、 数据层（Neo4j）：从“简单映射”到“三维本体”

**变更点：** 引入了符合电信规范的“场景-产品-规则”层级，并增加了物理路径的元数据定义。

### 1. 核心图谱结构

* **Entity 层（规格）**：定义 `RuleContext`（上下文）、`ProdInst`（产品实例）、`BusinessConstraint`（约束）。
* **Metadata 层（属性）**：映射 `ywlx` -> `COL1`。
* **Action 层（原子能力）**：定义 `ShouldSkipCheck`、`ValidateConstraint` 等标准动作。

### 2. 初始化 Cypher 脚本（直接执行）

```cypher
// 1. 约束与索引
CREATE CONSTRAINT metadata_path IF NOT EXISTS FOR (m:Metadata) REQUIRE m.path IS UNIQUE;

// 2. 建立专家定义的“三实体”架构
MERGE (rc:Entity {code: 'RuleContext', name: '规则上下文'})
MERGE (pi:Entity {code: 'ProdInst', name: '产品实例'})
MERGE (bc:Entity {code: 'BusinessConstraint', name: '业务约束'})

// 3. 注入专家整理的属性（数据字典锚定）
MATCH (pi:Entity {code: 'ProdInst'})
MERGE (m1:Metadata {id: 'businessTypeCode', label: '业务类型编码', path: 'COL1', source: 'AccessProdInst'})-[:BELONGS_TO]->(pi)
MERGE (m2:Metadata {id: 'prodId', label: '产品规格ID', path: 'PROD_ID'})-[:BELONGS_TO]->(pi)

// 4. 定义规则实例（灵犀专线融合光网约束）
MERGE (rule:RuleInstance {id: 'RULE_LX_001', name: '灵犀融合光网准入规则'})
SET rule.priority = 1, rule.category = 'PROD_RULE'
MERGE (rule)-[:CONSTRAINS]->(pi)

```

---

## 二、 后端层（Spring Boot）：从“逻辑解释”到“合规引擎”

**变更点：** 对齐规范 4.4 章节，增加规则热加载、高性能缓存及标准 OpenAPI 接口。

### 1. 规则编译器改进（NL2SpEL Adapter）

引入 RAG（检索增强生成）策略。后端在请求 LLM 前，先从 Neo4j 检索出 `COL1` 等物理字段，强制 LLM 使用。

* **核心逻辑**：`User NL` + `Neo4j Context (Metadata)` -> `LLM` -> `Validated SpEL`。

### 2. 标准 OpenAPI 接口（对齐规范序号 1-2）

* **接口名**：`PATCH /api/logos/v1/BusiRule`
* **功能**：实现规则的实时优化与热发布。
* **执行内核代码片段**：

```java
@Service
public class LogosEngine {
    // 预编译 SpEL 缓存，满足高峰期响应 <= 3s 要求
    private final Map<String, Expression> expressionCache = new ConcurrentHashMap<>();

    public RuleResult execute(String ruleId, Map<String, Object> payload) {
        // 1. 获取规则
        RuleInstance rule = ruleRepo.findById(ruleId);
        // 2. 校验豁免逻辑（对齐专家规则1：跳过检查规则）
        if (LogosUtils.isExempt(payload.get("operType"))) return RuleResult.pass();
        // 3. 执行核心逻辑
        Expression exp = expressionCache.computeIfAbsent(rule.getSpel(), k -> new SpelExpressionParser().parseExpression(k));
        return exp.getValue(new StandardEvaluationContext(payload), Boolean.class) ? RuleResult.pass() : RuleResult.block(rule.getErrorMsg());
    }
}

```

---

## 三、 前端层（React）：从“文本框”到“全生命周期工作台”

**变更点：** 增加“规则统一视图”与“可视化溯源”，对齐规范 4.3 章节展示要求。

### 1. 界面元素详细变更

* **规则视图组件 (RuleView)**：
* **树形导航**：场景（新装/变更） -> 产品（灵犀专线） -> 规则条目。
* **状态标签**：显示规则的“版本号”与“运行状态”。


* **语义溯源组件 (TraceLink)**：
* 当 SpEL 生成后，点击代码中的变量（如 `businessTypeCode`），界面高亮显示图谱中对应的 `COL1` 节点。


* **仿真沙箱 (Sandbox)**：
* 根据本体属性自动生成 Mock 表单（例如：自动生成 `COL1` 的下拉框，选项为 `3-融合光网`）。



### 2. 交互流程图

---

## 四、 开发执行路线图（直接指导开发）

### 第一阶段：底座构建（Day 1-2）

* **Neo4j**：执行上述 Cypher 脚本，录入《属性.csv》中的所有字段。
* **后端**：搭建 `LogosEvaluationContext`，实现基础的 SpEL 执行接口。

### 第二阶段：AI 适配与 RAG（Day 3-5）

* **后端**：集成 LLM 接口，编写 `PromptTemplate`，将 Neo4j 检索到的 `Metadata` 注入上下文。
* **前端**：实现源码知识提取页面，解析现有的 7 份 Java 插件并入库图谱。

### 第三阶段：合规性闭环（Day 6-8）

* **全链路**：对接标准 OpenAPI，完成规则的 `POST/PATCH` 闭环。
* **验证**：构造灵犀专线的 Mock 数据，验证“非拆机操作拦截”逻辑。

---

### 💡 给开发者的特别提示：

**“可解释”是本次变更的重中之重**。在后端返回给前端的响应中，必须包含一个 `trace` 字段，记录 LLM 推理时参考的本体路径：
`"trace": "业务需求(融合光网) -> 命中实体(ProdInst:80000122) -> 匹配属性(COL1) -> 常量值(3)"`

这个 trace 信息将直接用于前端的 **Graph Insight** 展示。

**是否需要我为您提供针对“灵犀专线”这一具体案例的完整前后端报文 Mock 示例，以便您直接开始联调？**