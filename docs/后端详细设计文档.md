è¿™ä»½åç«¯è¯¦ç»†è®¾è®¡æ–‡æ¡£ä¸“é—¨é’ˆå¯¹ **LOGOS (æ™ºèƒ½è§„åˆ™ä¸­å°)** é¡¹ç›®ï¼Œç»“åˆä¸šåŠ¡ä¸“å®¶æ•´ç†çš„ MVP æ¨¡å¼è®¾è®¡ï¼Œæ—¨åœ¨å°†è‡ªç„¶è¯­è¨€éœ€æ±‚ç²¾å‡†è½¬åŒ–ä¸ºå¯æ‰§è¡Œçš„ SpEL è„šæœ¬ã€‚

---

# LOGOS åç«¯è¯¦ç»†è®¾è®¡æ–‡æ¡£

## 1. Neo4j æœ¬ä½“æ•°æ®æ¨¡å‹è¯¦ç»†è®¾è®¡

åŸºäºä¸“å®¶æä¾›çš„â€œå®ä½“ã€å±æ€§ã€å…³ç³»â€è¡¨ï¼Œæˆ‘ä»¬å°†ç‰©ç†ä»£ç é€»è¾‘æŠ½è±¡ä¸ºå›¾æ‹“æ‰‘ã€‚

### 1.1 èŠ‚ç‚¹æ ‡ç­¾ä¸å±æ€§æ˜ å°„

* **`:Entity`**: é¡¶å±‚æ¦‚å¿µèŠ‚ç‚¹ï¼ˆå¦‚ `RuleContext`, `ProdInst`ï¼‰ã€‚
* **`:Metadata`**: å±æ€§å…ƒæ•°æ®ï¼Œå­˜å‚¨ç‰©ç†è·¯å¾„ï¼ˆå¦‚ `col1`, `attrib_125`ï¼‰ã€‚
* **`:BusinessConstraint`**: é€»è¾‘çº¦æŸèŠ‚ç‚¹ï¼Œå­˜å‚¨å…è®¸çš„åŠ¨ä½œå’Œè±å…æ¡ä»¶ã€‚
* **`:Function`**: åŸå­èƒ½åŠ›èŠ‚ç‚¹ï¼Œå­˜å‚¨ SpEL æ˜ å°„å‡½æ•°ã€‚

### 1.2 MERGE åˆå§‹åŒ–è„šæœ¬ç¤ºä¾‹

```cypher
// 1. åˆ›å»ºæ ¸å¿ƒå®ä½“
MERGE (c:Entity {code: 'RuleContext', name: 'è§„åˆ™ä¸Šä¸‹æ–‡'})
MERGE (p:Entity {code: 'ProdInst', name: 'äº§å“å®ä¾‹'})
MERGE (b:Entity {code: 'BusinessConstraint', name: 'ä¸šåŠ¡çº¦æŸ'})

// 2. åˆ›å»ºç‰©ç†å±æ€§æ˜ å°„ (ä»¥çµçŠ€ä¸“çº¿ä¸ºä¾‹)
MERGE (m1:Metadata {id: 'ywlx', name: 'ä¸šåŠ¡ç±»å‹', path: 'col1', type: 'String'})-[:BELONGS_TO]->(p)
MERGE (m2:Metadata {id: 'soId', name: 'æœåŠ¡æä¾›ID', path: 'orderRequest.serviceOfferId'})-[:BELONGS_TO]->(c)

// 3. æ„å»ºä¸šåŠ¡çº¦æŸå®ä¾‹ (èåˆå…‰ç½‘çº¦æŸ)
MERGE (bc:BusinessConstraint {
    id: 'BC_LX_001', 
    name: 'èåˆå…‰ç½‘çº¦æŸ',
    targetProductId: '80000122',
    targetBusinessType: '3',
    allowedActions: '2831', // ä»…å…è®¸æ‹†æœº
    exemptOperTypes: '["1100", "1200"]'
})

// 4. å»ºç«‹ä¸“å®¶å®šä¹‰çš„è¯­ä¹‰å…³ç³»
MATCH (p1:Entity {code:'RuleContext'}), (p2:Entity {code:'ProdInst'})
MERGE (p1)-[:appliesTo]->(p2)

```

---

## 2. SpEL æ‰§è¡Œå¼•æ“å®ç°æ–¹æ¡ˆ

å¼•æ“å±‚è´Ÿè´£å°†é€»è¾‘è¡¨è¾¾å¼ä¸å®æ—¶ä¸šåŠ¡æ•°æ®ç»“åˆã€‚

### 2.1 æ ¸å¿ƒç»„ä»¶è®¾è®¡

* **`LogosEvaluationContext`**: ç»§æ‰¿è‡ª `StandardEvaluationContext`ï¼Œé¢„åŠ è½½ `Context`ã€`Inst` å’Œ `Constraint` æ ¹å¯¹è±¡ã€‚
* **`RootObjectWrapper`**: åŒ…è£…ç±»ï¼Œè‡ªåŠ¨å°† SpEL ä¸­çš„è¯­ä¹‰åï¼ˆå¦‚ `ywlx`ï¼‰é€šè¿‡è§£ææ˜ å°„å› `AccessProdInst.getAttr('col1')`ã€‚
* **`FunctionRegistry`**: æ³¨å†Œè‡ªå®šä¹‰ç®—å­ï¼ˆå¦‚ `matches()`, `inList()`ï¼‰ã€‚

### 2.2 æ‰§è¡Œé€»è¾‘ä¼ªä»£ç 

```java
public EvaluationResult evaluate(String spel, Map<String, Object> data) {
    // 1. åˆå§‹åŒ–ä¸Šä¸‹æ–‡
    LogosEvaluationContext context = new LogosEvaluationContext(data);
    // 2. æ³¨å…¥å·¥å…·ç±» (å¦‚ä¸“å®¶å®šä¹‰çš„ ShouldSkipCheck é€»è¾‘)
    context.registerFunction("skipCheck", ReflectionUtils.getMethod(LogosUtils.class, "shouldSkip", ...));
    // 3. æ‰§è¡Œè§£æ
    Expression expression = parser.parseExpression(spel);
    return expression.getValue(context, EvaluationResult.class);
}

```

---

## 3. LLM æ¥å£é€‚é…å±‚è®¾è®¡ (Multi-LLM Adapter)

é€‚é…å±‚å±è”½ä¸åŒæ¨¡å‹ API çš„å·®å¼‚ï¼Œæ”¯æŒåŠ¨æ€åˆ‡æ¢ã€‚

### 3.1 é€‚é…å±‚æ¶æ„

* **`LlmClient` æ¥å£**: å®šä¹‰ `chat(Prompt prompt)` æ–¹æ³•ã€‚
* **å…·ä½“å®ç°**: `GptClient`, `ClaudeClient`, `DeepSeekClient`ã€‚
* **ç­–ç•¥æ¨¡å¼**: é€šè¿‡é…ç½®ä¸­å¿ƒï¼ˆNacos/Apolloï¼‰æˆ– Header åŠ¨æ€è·¯ç”±æ¨¡å‹ã€‚

### 3.2 æç¤ºè¯æ¨¡æ¿ç»“æ„

```yaml
prompt_template:
  role: "ä½ æ˜¯ä¸€ä¸ªè§„åˆ™ç¼–è¯‘å™¨ï¼ŒåŸºäºæä¾›çš„æœ¬ä½“å…ƒæ•°æ®ç”Ÿæˆ SpELã€‚"
  context: "æœ¬ä½“å®šä¹‰: ${ontology_context}"
  task: "å°†è‡ªç„¶è¯­è¨€ '${user_input}' è½¬åŒ–ä¸ºç¬¦åˆé€»è¾‘çš„ SpEL è¡¨è¾¾å¼ã€‚"
  output_format: "JSON { spel: string, explanation: string }"

```

---

## 4. çŸ¥è¯†å›¾è°± RAG æ£€ç´¢ç­–ç•¥

ä¸ºè§£å†³ LLM ç”Ÿæˆè¿‡ç¨‹ä¸­çš„â€œå¹»è§‰â€é—®é¢˜ï¼Œå¿…é¡»å…ˆä» Neo4j æå–äº‹å®ã€‚

### 4.1 æ£€ç´¢æµç¨‹ (Workflow)

1. **å®ä½“æå–**: LLM é¦–å…ˆè¯†åˆ« NL ä¸­çš„å®ä½“ï¼ˆå¦‚â€œçµçŠ€ä¸“çº¿â€ã€â€œä¸šåŠ¡ç±»å‹â€ï¼‰ã€‚
2. **å›¾è°±æœç´¢**:
* `MATCH (p:Product {name: 'çµçŠ€ä¸“çº¿'})-[:BELONGS_TO]-(m) RETURN m`
* è·å–ç‰©ç†è·¯å¾„ `col1` å’Œæšä¸¾å€¼ `3`ã€‚


3. **ä¸Šä¸‹æ–‡æ³¨å…¥**: å°†æœç´¢åˆ°çš„å…ƒæ•°æ®è·¯å¾„æ³¨å…¥ Prompt çš„ `ontology_context`ã€‚
4. **æŒ‰éœ€ç¼–è¯‘**: LLM ä»…è´Ÿè´£é€»è¾‘ç»„è£…ï¼Œå­—æ®µåå¼ºåˆ¶ä½¿ç”¨æ£€ç´¢åˆ°çš„ Metadata IDã€‚

---

## 5. æ¥å£å®Œæ•´ OpenAPI è§„èŒƒ (éƒ¨åˆ†å±•ç¤º)

```yaml
openapi: 3.0.0
info:
  title: LOGOS æ™ºèƒ½è§„åˆ™å¼•æ“ API
  version: 1.0.0
paths:
  /api/v1/rule/generate:
    post:
      summary: è‡ªç„¶è¯­è¨€ç”Ÿæˆ SpEL
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                nl_input: {type: string, example: "èåˆå…‰ç½‘ä¸šåŠ¡åªå…è®¸æ‹†æœº"}
                product_id: {type: string, example: "80000122"}
      responses:
        '200':
          description: ç”ŸæˆæˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  spel: {type: string}
                  explanation: {type: string}
                  trace_nodes: {type: array, items: {type: string}}

  /api/v1/rule/execute:
    post:
      summary: ä»¿çœŸæ‰§è¡Œä¸éªŒè¯
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                spel: {type: string}
                mock_data: {type: object}
      responses:
        '200':
          description: æ‰§è¡ŒæˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  result: {type: boolean}
                  logs: {type: array, items: {type: string}}

```

---

### ğŸ’¡ å…³é”®è®¾è®¡è¯´æ˜ï¼š

* **ä¸€è‡´æ€§ä¿è¯**: æ‰€æœ‰çš„ `Metadata` å¿…é¡»åœ¨ Neo4j ä¸­ä½œä¸ºâ€œå”¯ä¸€äº‹å®æºâ€ï¼ŒLLM ä¸å¾—è‡ªè¡Œç”Ÿæˆå­—æ®µåã€‚
* **å¯è§£é‡Šæ€§**: ç”Ÿæˆæ¥å£å¿…é¡»è¿”å› `trace_nodes`ï¼Œç”¨äºåœ¨å‰ç«¯ React ç•Œé¢ä¸Šé«˜äº®æ˜¾ç¤ºå‘½ä¸­å›¾è°±ä¸­çš„å“ªäº›èŠ‚ç‚¹ï¼Œå®ç°ä¸“å®¶è¦æ±‚çš„â€œè¯­ä¹‰æº¯æºâ€ã€‚